name: BTC Sentiment Pipeline

on:
  # Run on schedule (every hour)
  schedule:
    - cron: '0 * * * *'  # Every hour at minute 0
  
  # Allow manual triggering
  workflow_dispatch:
  
  # Run on push to main (optional - for testing)
  push:
    branches:
      - main
    paths:
      - 'src/pipelines/**'
      - '.github/workflows/pipeline.yml'

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write  # Allow creating releases and uploading artifacts
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Check disk space
        run: |
          df -h
          echo "Available disk space before installation"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install CPU-only PyTorch first (much smaller, ~200MB vs ~3GB)
          # This prevents running out of disk space on GitHub Actions
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          # Install transformers (depends on torch)
          pip install transformers
          # Then install rest of requirements (excluding torch and transformers)
          pip install fastapi uvicorn streamlit sqlalchemy pandas pydantic-settings plotly requests pytest httpx python-json-logger feedparser schedule
          # Clean up pip cache to save space
          pip cache purge
      
      - name: Check disk space after installation
        run: |
          df -h
          echo "Available disk space after installation"
      
      - name: Load .env file
        run: |
          # Use the committed .env file from the repository
          echo "Using .env file from repository:"
          cat .env
      
      - name: Download database from latest release
        id: download_db
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ” Checking for existing database releases..."
          
          # Get the most recent database release tag
          LATEST_TAG=$(gh release list --limit 100 --json tagName,createdAt \
            | jq -r '[.[] | select(.tagName | startswith("db-"))] | sort_by(.createdAt) | reverse | .[0].tagName' \
            | head -1)
          
          if [ ! -z "$LATEST_TAG" ] && [ "$LATEST_TAG" != "null" ]; then
            echo "ğŸ“¥ Found latest database release: $LATEST_TAG"
            echo "   Downloading database..."
            
            # Download the database file from the release
            if gh release download "$LATEST_TAG" --pattern "btc_sentiment.db" --clobber; then
              if [ -f "btc_sentiment.db" ]; then
                echo "âœ… Database downloaded successfully"
                echo "db_source=release" >> $GITHUB_OUTPUT
                ls -lh btc_sentiment.db
                sqlite3 btc_sentiment.db "SELECT granularity, COUNT(*) as count FROM sentiment_indices GROUP BY granularity;" 2>/dev/null || echo "   (Database stats unavailable)"
              else
                echo "âš ï¸ Expected btc_sentiment.db after download, but file is missing."
                echo "   Will start with fresh database"
                echo "db_source=fresh" >> $GITHUB_OUTPUT
              fi
            else
              echo "âš ï¸ Download failed for existing database release: $LATEST_TAG"
              echo "   Will start with fresh database"
              echo "db_source=fresh" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸  No previous database releases found"
            echo "   This is normal on first run - will create new database"
            echo "db_source=fresh" >> $GITHUB_OUTPUT
          fi
      
      - name: Run collection pipeline
        run: |
          python -m src.pipelines.collect
      
      - name: Run scoring pipeline
        run: |
          # Use a longer lookback so missed items can be backfilled after outages.
          python -m src.pipelines.score --since-hours 720
      
      - name: Run aggregation pipeline (hourly)
        run: |
          python -m src.pipelines.aggregate --granularity hourly --days 7
      
      - name: Run aggregation pipeline (daily)
        run: |
          python -m src.pipelines.aggregate --granularity daily --days 30
      
      - name: Cleanup old data (keep 60 days)
        run: |
          python -m src.pipelines.cleanup --retention-days 60
      
      - name: Upload database as artifact (backup)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: database
          path: btc_sentiment.db
          retention-days: 7
          if-no-files-found: warn
      
      - name: Upload to GitHub Release
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ“¦ Preparing database release..."
          
          if [ ! -f "btc_sentiment.db" ]; then
            echo "âŒ Database file not found!"
            exit 1
          fi
          
          # Show database stats before upload
          echo "Database size: $(du -h btc_sentiment.db | cut -f1)"
          echo "Records by granularity:"
          sqlite3 btc_sentiment.db "SELECT granularity, COUNT(*) as count FROM sentiment_indices GROUP BY granularity;" || echo "  (Stats unavailable)"
          
          # Create a release tag with timestamp
          TAG_NAME="db-$(date +%Y%m%d-%H%M%S)"
          
          echo "ğŸš€ Creating release: $TAG_NAME"
          
          # Create release and upload database
          if ! gh release create "$TAG_NAME" btc_sentiment.db \
            --title "Database Update $(date '+%Y-%m-%d %H:%M UTC')" \
            --notes "Automated database update from pipeline. Contains accumulated sentiment data." \
            --repo ${{ github.repository }} 2>&1; then
            echo "âŒ Failed to create release. Error details above."
            echo "âš ï¸ Database has been saved as artifact for recovery"
            exit 1
          fi
          
          echo "âœ… Release created successfully: $TAG_NAME"
          
          # Keep only the 3 most recent releases (cleanup old ones)
          echo "ğŸ§¹ Cleaning up old database releases..."
          
          # Get all database releases, sort by creation date (newest first)
          # Skip the first 3 (newest) and delete the rest (.[3:])
          OLD_RELEASES=$(gh release list --limit 100 --json tagName,createdAt \
            | jq -r '[.[] | select(.tagName | startswith("db-"))] | sort_by(.createdAt) | reverse | .[3:] | .[] | .tagName')
          
          if [ ! -z "$OLD_RELEASES" ]; then
            echo "$OLD_RELEASES" | while IFS= read -r TAG; do
              if [ ! -z "$TAG" ]; then
                echo "  Deleting old release: $TAG"
                gh release delete "$TAG" --yes --cleanup-tag || echo "    (Failed to delete $TAG, continuing...)"
              fi
            done
            echo "âœ… Cleanup complete - kept last 3 releases"
          else
            echo "âœ… No old releases to delete (keeping all releases)"
          fi
      
      - name: Export data to JSON for GitHub Pages
        run: |
          echo "ğŸ“„ Exporting database to JSON files..."
          python -m src.pipelines.export_json api-output
          
          echo "âœ… JSON files generated:"
          ls -lh api-output/
      
      - name: Check for changes in JSON files
        id: check_changes
        run: |
          # Check if any JSON files have changed
          if git diff --quiet gh-pages -- api-output/ 2>/dev/null; then
            echo "No changes detected in JSON files"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in JSON files"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy to GitHub Pages
        if: steps.check_changes.outputs.has_changes == 'true' || github.event_name == 'workflow_dispatch'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./api-output
          publish_branch: gh-pages
          cname: false
      
      - name: Summary
        run: |
          echo "âœ… Pipeline completed successfully"
          if [ -f "btc_sentiment.db" ]; then
            echo "ğŸ“¦ Database uploaded to GitHub Release"
            echo "ğŸ“„ JSON API deployed to GitHub Pages"
            echo "ğŸŒ API available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api"
            echo ""
            echo "Database info:"
            ls -lh btc_sentiment.db
            echo ""
            echo "Next run will download this database and append new data"
          else
            echo "âš ï¸ No database file found"
          fi


